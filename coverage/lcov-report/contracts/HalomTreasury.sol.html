<!doctype html>
<html lang="en">
<head>
    <title>Code coverage report for contracts\HalomTreasury.sol</title>
    <meta charset="utf-8" />
    <link rel="stylesheet" href="../prettify.css" />
    <link rel="stylesheet" href="../base.css" />
    <meta name="viewport" content="width=device-width, initial-scale=1">
    <style type='text/css'>
        .coverage-summary .sorter {
            background-image: url(../sort-arrow-sprite.png);
        }
    </style>
</head>
<body>
<div class='wrapper'>
  <div class='pad1'>
    <h1>
      <a href="../index.html">all files</a> / <a href="index.html">contracts/</a> HalomTreasury.sol
    </h1>
    <div class='clearfix'>
      <div class='fl pad1y space-right2'>
        <span class="strong">46.43% </span>
        <span class="quiet">Statements</span>
        <span class='fraction'>26/56</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">32.5% </span>
        <span class="quiet">Branches</span>
        <span class='fraction'>26/80</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">50% </span>
        <span class="quiet">Functions</span>
        <span class='fraction'>8/16</span>
      </div>
      <div class='fl pad1y space-right2'>
        <span class="strong">44.44% </span>
        <span class="quiet">Lines</span>
        <span class='fraction'>32/72</span>
      </div>
    </div>
  </div>
  <div class='status-line low'></div>
<pre><table class="coverage">
<tr><td class="line-count quiet">1
2
3
4
5
6
7
8
9
10
11
12
13
14
15
16
17
18
19
20
21
22
23
24
25
26
27
28
29
30
31
32
33
34
35
36
37
38
39
40
41
42
43
44
45
46
47
48
49
50
51
52
53
54
55
56
57
58
59
60
61
62
63
64
65
66
67
68
69
70
71
72
73
74
75
76
77
78
79
80
81
82
83
84
85
86
87
88
89
90
91
92
93
94
95
96
97
98
99
100
101
102
103
104
105
106
107
108
109
110
111
112
113
114
115
116
117
118
119
120
121
122
123
124
125
126
127
128
129
130
131
132
133
134
135
136
137
138
139
140
141
142
143
144
145
146
147
148
149
150
151
152
153
154
155
156
157
158
159
160
161
162
163
164
165
166
167
168
169
170
171
172
173
174
175
176
177
178
179
180
181
182
183
184
185
186
187
188
189
190
191
192
193
194
195
196
197
198
199
200
201
202
203
204
205
206
207
208
209
210
211
212
213
214
215
216
217
218
219
220
221
222
223
224
225
226
227
228
229
230
231
232
233
234
235
236
237
238
239
240
241
242
243
244
245
246
247
248
249
250
251
252
253
254
255
256
257
258
259
260
261
262
263
264
265
266
267
268
269
270
271
272
273
274
275
276
277
278
279
280
281
282
283
284
285
286
287
288
289
290
291
292
293
294
295
296
297
298
299
300
301
302
303
304
305
306
307
308
309</td><td class="line-coverage quiet"><span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">86×</span>
<span class="cline-any cline-yes">86×</span>
<span class="cline-any cline-yes">86×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">86×</span>
<span class="cline-any cline-yes">86×</span>
<span class="cline-any cline-yes">86×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">86×</span>
<span class="cline-any cline-yes">86×</span>
<span class="cline-any cline-yes">86×</span>
<span class="cline-any cline-yes">86×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">3×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">2×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-yes">1×</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-no">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span>
<span class="cline-any cline-neutral">&nbsp;</span></td><td class="text"><pre class="prettyprint lang-js">// SPDX-License-Identifier: MIT
pragma solidity ^0.8.20;
&nbsp;
import "@openzeppelin/contracts/token/ERC20/IERC20.sol";
import "@openzeppelin/contracts/token/ERC20/utils/SafeERC20.sol";
import "@openzeppelin/contracts/utils/ReentrancyGuard.sol";
import "@openzeppelin/contracts/access/AccessControl.sol";
import "@openzeppelin/contracts/utils/Pausable.sol";
import "./HalomToken.sol";
import "./interfaces/IHalomInterfaces.sol";
&nbsp;
/**
 * @title HalomTreasury
 * @dev Treasury contract for managing protocol fees and DAO funds
 * Implements secure role structure with proper governance controls
 */
contract HalomTreasury is AccessControl, ReentrancyGuard, Pausable {
    using SafeERC20 for IERC20;
&nbsp;
    bytes32 public constant GOVERNOR_ROLE = keccak256("GOVERNOR_ROLE");
    bytes32 public constant OPERATOR_ROLE = keccak256("OPERATOR_ROLE");
    bytes32 public constant TREASURY_CONTROLLER = keccak256("TREASURY_CONTROLLER");
    bytes32 public constant PAUSER_ROLE = keccak256("PAUSER_ROLE");
&nbsp;
    IHalomToken public immutable halomToken;
    IERC20 public immutable eurcToken; // EURC instead of DAI
    IHalomRoleManager public roleManager;
&nbsp;
    // Fourth root based fee distribution
    uint256 public totalFourthRootFees; // Sum of fourth roots of all fee contributions
    mapping(address =&gt; uint256) public fourthRootFees; // Fourth root of user's fee contribution
    uint256 public rewardsPerFourthRoot; // Rewards per fourth root unit
    mapping(address =&gt; uint256) public rewardDebt;
&nbsp;
    // Fee collection
    uint256 public totalFeesCollected;
    mapping(address =&gt; uint256) public userFeeContributions;
&nbsp;
    // Treasury parameters
    uint256 public feeRate = 25; // 0.25% in basis points
    uint256 public constant MAX_FEE_RATE = 100; // 1% maximum
    uint256 public constant MIN_FEE_RATE = 1; // 0.01% minimum
&nbsp;
    // Fee distribution addresses
    address public stakingAddress;
    address public lpStakingAddress;
    address public daoReserveAddress;
    
    // Fee distribution percentages (in basis points)
    uint256 public stakingFeePercentage = 6000; // 60%
    uint256 public lpStakingFeePercentage = 2000; // 20%
    uint256 public daoReserveFeePercentage = 2000; // 20%
&nbsp;
    // Treasury management
    uint256 public maxWithdrawalAmount = 1000000e18; // 1M HLM max withdrawal
    uint256 public withdrawalCooldown = 24 hours;
    mapping(address =&gt; uint256) public lastWithdrawalTime;
&nbsp;
    event FeeCollected(address indexed user, uint256 amount, uint256 fourthRoot);
    event FeeDistributed(address indexed user, uint256 amount);
    event FeeRateUpdated(uint256 oldRate, uint256 newRate);
    event EmergencyRecovery(address indexed token, address indexed to, uint256 amount);
    event TreasuryPaused(address indexed pauser);
    event TreasuryUnpaused(address indexed unpauser);
    event FeeDistributionUpdated(address staking, address lpStaking, address daoReserve);
    event FeePercentagesUpdated(uint256 staking, uint256 lpStaking, uint256 daoReserve);
    event TreasuryWithdrawal(address indexed to, uint256 amount, address indexed controller);
    event WithdrawalParametersUpdated(uint256 maxAmount, uint256 cooldown);
&nbsp;
    constructor(
        address _halomToken,
        address _eurcToken,
        address _roleManager
    ) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_halomToken != address(0), "Halom token is zero address");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_eurcToken != address(0), "EURC token is zero address");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_roleManager != address(0), "Role manager is zero address");
&nbsp;
        halomToken = IHalomToken(_halomToken);
        eurcToken = IERC20(_eurcToken);
        roleManager = IHalomRoleManager(_roleManager);
        
        // Roles will be granted by deployment script, not in constructor
        _grantRole(DEFAULT_ADMIN_ROLE, _roleManager);
        _grantRole(GOVERNOR_ROLE, _roleManager);
        _grantRole(TREASURY_CONTROLLER, _roleManager);
        _grantRole(PAUSER_ROLE, _roleManager);
    }
&nbsp;
    /**
     * @dev Calculate fourth root using Babylonian method
     */
<span class="fstat-no" title="function not covered" >    function fourthRoot(uint256 x) public pure returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >        if (x == 0) <span class="cstat-no" title="statement not covered" >return 0;</span></span>
<span class="cstat-no" title="statement not covered" >        uint256 z = x;</span>
<span class="cstat-no" title="statement not covered" >        uint256 y = (z + 3) / 4;</span>
        
<span class="cstat-no" title="statement not covered" >        while (y &lt; z) {</span>
            z = y;
            y = (3 * z + x / (z * z * z)) / 4;
        }
<span class="cstat-no" title="statement not covered" >        return z;</span>
    }
&nbsp;
    /**
     * @dev Collect fees from user (only treasury controller)
     */
    function collectFees(address _user, uint256 _amount) external <span class="missing-if-branch" title="else path not taken" >E</span>onlyRole(TREASURY_CONTROLLER) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_user != address(0), "Cannot collect from zero address");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_amount &gt; 0, "Cannot collect 0 fees");
        
        // Remove transferFrom since HalomToken now mints directly
        // halomToken.safeTransferFrom(_user, address(this), _amount);
        
        emit FeeCollected(_user, _amount, 0); // fourthRoot is 0 since we're not calculating it here
    }
&nbsp;
    /**
     * @dev Distribute fees to users based on fourth root
     */
    function distributeFees(uint256 _amount) external <span class="missing-if-branch" title="else path not taken" >E</span>onlyRole(TREASURY_CONTROLLER) {
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_amount &gt; 0, "Amount must be greater than 0");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_amount &lt;= halomToken.balanceOf(address(this)), "Insufficient treasury balance");
        
        <span class="missing-if-branch" title="if path not taken" >I</span>if (totalFourthRootFees &gt; 0) {
            rewardsPerFourthRoot += (_amount * 1e18) / totalFourthRootFees;
        }
        
        emit FeeDistributed(msg.sender, _amount);
    }
&nbsp;
    /**
     * @dev Claim user's fee rewards
     */
<span class="fstat-no" title="function not covered" >    function claimFeeRewards() external nonReentrant whenNotPaused {</span>
<span class="cstat-no" title="statement not covered" >        uint256 pending = (fourthRootFees[msg.sender] * rewardsPerFourthRoot) / 1e18 - rewardDebt[msg.sender];</span>
<span class="cstat-no" title="statement not covered" >        require(pending &gt; 0, "No rewards to claim")</span>;
        
        // halomToken.safeTransfer(msg.sender, pending);
<span class="cstat-no" title="statement not covered" >        SafeERC20.safeTransfer(IERC20(address(halomToken)), msg.sender, pending)</span>;
        rewardDebt[msg.sender] = (fourthRootFees[msg.sender] * rewardsPerFourthRoot) / 1e18;
        
<span class="cstat-no" title="statement not covered" >        emit FeeDistributed(msg.sender, pending);</span>
    }
&nbsp;
    /**
     * @dev Withdraw treasury funds (only treasury controller)
     */
<span class="fstat-no" title="function not covered" >    function withdrawTreasuryFunds(</span>
        address _to,
        uint256 _amount,
        bool _isEmergency
    ) external <span class="missing-if-branch" title="if path not taken" >I</span>onlyRole(TREASURY_CONTROLLER) {
<span class="cstat-no" title="statement not covered" >        require(_to != address(0), "Cannot withdraw to zero address")</span>;
<span class="cstat-no" title="statement not covered" >        require(_amount &gt; 0, "Amount must be greater than 0")</span>;
<span class="cstat-no" title="statement not covered" >        require(_amount &lt;= halomToken.balanceOf(address(this)), "Insufficient treasury balance")</span>;
        
<span class="cstat-no" title="statement not covered" >        if (!_isEmergency) {</span>
<span class="cstat-no" title="statement not covered" >            require(_amount &lt;= maxWithdrawalAmount, "Amount exceeds maximum withdrawal")</span>;
<span class="cstat-no" title="statement not covered" >            require(block.timestamp &gt;= lastWithdrawalTime[_to] + withdrawalCooldown, "Withdrawal cooldown not met")</span>;
            lastWithdrawalTime[_to] = block.timestamp;
        }
        
        // halomToken.safeTransfer(_to, _amount);
<span class="cstat-no" title="statement not covered" >        SafeERC20.safeTransfer(IERC20(address(halomToken)), _to, _amount)</span>;
        
<span class="cstat-no" title="statement not covered" >        emit TreasuryWithdrawal(_to, _amount, msg.sender);</span>
    }
&nbsp;
    /**
     * @dev Update fee rate (only governor)
     */
<span class="fstat-no" title="function not covered" >    function updateFeeRate(uint256 _newRate) external onlyRole(GOVERNOR_ROLE) {</span>
<span class="cstat-no" title="statement not covered" >        require(_newRate &gt;= MIN_FEE_RATE &amp;&amp; _newRate &lt;= MAX_FEE_RATE, "Fee rate out of bounds")</span>;
        
<span class="cstat-no" title="statement not covered" >        uint256 oldRate = feeRate;</span>
        feeRate = _newRate;
        
<span class="cstat-no" title="statement not covered" >        emit FeeRateUpdated(oldRate, _newRate);</span>
    }
&nbsp;
    /**
     * @dev Update fee distribution addresses (only governor)
     */
    function updateFeeDistributionAddresses(
        address _stakingAddress,
        address _lpStakingAddress,
        address _daoReserveAddress
    ) external <span class="missing-if-branch" title="else path not taken" >E</span>onlyRole(GOVERNOR_ROLE) {
        require(_stakingAddress != address(0), "Staking address cannot be zero");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_lpStakingAddress != address(0), "LP staking address cannot be zero");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_daoReserveAddress != address(0), "DAO reserve address cannot be zero");
        
        stakingAddress = _stakingAddress;
        lpStakingAddress = _lpStakingAddress;
        daoReserveAddress = _daoReserveAddress;
        
        emit FeeDistributionUpdated(_stakingAddress, _lpStakingAddress, _daoReserveAddress);
    }
&nbsp;
    /**
     * @dev Update fee distribution percentages (only governor)
     */
    function updateFeePercentages(
        uint256 _stakingPercentage,
        uint256 _lpStakingPercentage,
        uint256 _daoReservePercentage
    ) external <span class="missing-if-branch" title="else path not taken" >E</span>onlyRole(GOVERNOR_ROLE) {
        require(
            _stakingPercentage + _lpStakingPercentage + _daoReservePercentage == 10000,
            "Percentages must sum to 100%"
        );
        <span class="missing-if-branch" title="if path not taken" >I</span>require(_stakingPercentage &gt; 0, "Staking percentage must be greater than 0");
<span class="cstat-no" title="statement not covered" >        require(_lpStakingPercentage &gt; 0, "LP staking percentage must be greater than 0")</span>;
<span class="cstat-no" title="statement not covered" >        require(_daoReservePercentage &gt; 0, "DAO reserve percentage must be greater than 0")</span>;
        
        stakingFeePercentage = _stakingPercentage;
        lpStakingFeePercentage = _lpStakingPercentage;
        daoReserveFeePercentage = _daoReservePercentage;
        
<span class="cstat-no" title="statement not covered" >        emit FeePercentagesUpdated(_stakingPercentage, _lpStakingPercentage, _daoReservePercentage);</span>
    }
&nbsp;
    /**
     * @dev Update withdrawal parameters (only governor)
     */
<span class="fstat-no" title="function not covered" >    function updateWithdrawalParameters(uint256 _maxAmount, uint256 _cooldown) external onlyRole(GOVERNOR_ROLE) {</span>
<span class="cstat-no" title="statement not covered" >        require(_maxAmount &gt; 0, "Max amount must be greater than 0")</span>;
<span class="cstat-no" title="statement not covered" >        require(_cooldown &lt;= 7 days, "Cooldown too long")</span>;
        
        maxWithdrawalAmount = _maxAmount;
        withdrawalCooldown = _cooldown;
        
<span class="cstat-no" title="statement not covered" >        emit WithdrawalParametersUpdated(_maxAmount, _cooldown);</span>
    }
&nbsp;
    /**
     * @dev Emergency recovery function to withdraw tokens sent by mistake
     * @param _token Token address to recover
     * @param _to Address to send tokens to
     * @param _amount Amount to recover
     */
    function emergencyRecovery(
        address _token,
        address _to,
        uint256 _amount
    ) external <span class="missing-if-branch" title="else path not taken" >E</span>onlyRole(GOVERNOR_ROLE) {
        require(_to != address(0), "Cannot recover to zero address");
        <span class="missing-if-branch" title="else path not taken" >E</span>require(_amount &gt; 0, "Cannot recover 0 amount");
        
        IERC20(_token).safeTransfer(_to, _amount);
        emit EmergencyRecovery(_token, _to, _amount);
    }
&nbsp;
    /**
     * @dev Pause treasury operations (emergency)
     */
    function pause() external <span class="missing-if-branch" title="else path not taken" >E</span>onlyRole(PAUSER_ROLE) {
        _pause();
    }
&nbsp;
    /**
     * @dev Unpause treasury operations
     */
    function unpause() external <span class="missing-if-branch" title="else path not taken" >E</span>onlyRole(GOVERNOR_ROLE) {
        _unpause();
    }
&nbsp;
    /**
     * @dev Get user's pending fee rewards
     */
<span class="fstat-no" title="function not covered" >    function getPendingFeeRewards(address _user) public view returns (uint256) {</span>
<span class="cstat-no" title="statement not covered" >        return (fourthRootFees[_user] * rewardsPerFourthRoot) / 1e18 - rewardDebt[_user];</span>
    }
&nbsp;
    /**
     * @dev Get treasury info
     */
<span class="fstat-no" title="function not covered" >    function getTreasuryInfo() external view returns (</span>
        uint256 _totalFeesCollected,
        uint256 _totalFourthRootFees,
        uint256 _rewardsPerFourthRoot,
        uint256 _halomBalance,
        uint256 _eurcBalance
    ) {
<span class="cstat-no" title="statement not covered" >        return (</span>
            totalFeesCollected,
            totalFourthRootFees,
            rewardsPerFourthRoot,
            halomToken.balanceOf(address(this)),
            eurcToken.balanceOf(address(this))
        );
    }
&nbsp;
    /**
     * @dev Get user's fee contribution info
     */
<span class="fstat-no" title="function not covered" >    function getUserFeeInfo(address _user) external view returns (</span>
        uint256 _contribution,
        uint256 _fourthRoot,
        uint256 _pendingRewards
    ) {
<span class="cstat-no" title="statement not covered" >        return (</span>
            userFeeContributions[_user],
            fourthRootFees[_user],
            getPendingFeeRewards(_user)
        );
    }
} </pre></td></tr>
</table></pre>
<div class='push'></div><!-- for sticky footer -->
</div><!-- /wrapper -->
<div class='footer quiet pad2 space-top1 center small'>
  Code coverage
  generated by <a href="http://istanbul-js.org/" target="_blank">istanbul</a> at Sat Jun 28 2025 13:18:46 GMT+0200 (közép-európai nyári idő)
</div>
</div>
<script src="../prettify.js"></script>
<script>
window.onload = function () {
        if (typeof prettyPrint === 'function') {
            prettyPrint();
        }
};
</script>
<script src="../sorter.js"></script>
</body>
</html>
